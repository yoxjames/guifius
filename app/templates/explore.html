{% extends "base.html" %}
{% block head %}

<script src="{{ url_for('static', filename='js/exploremap.js')}}" defer="defer"></script>
<script src="{{ url_for('static', filename='js/CustomLayers-2.12/OpenLayers.js') }}"></script>
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='olstyle.css') }}">


<!-- Non jQuery javascript. Used for behinds the scenes non visual
stuff
-->
<script type="text/javascript">

/*
 * draw_nodes
 * This function takes no input and is supposed to draw all the
 * nodes on the map. We may eventually want to split this into
 * three functions for the different node types but for now it
 * just does everything. 
 *
 */
function draw_nodes() {
  var fn = {
             'pointRadis':5,
             'fillColor': '#000000'
           };
  var fnsty = OpenLayers.Util.applyDefaults(fn,OpenLayers.Feature.Vector.style["defaults"]);
  var fnstyle = new OpenLayers.StyleMap({'pointRadius':5,'fillColor': '#000000'});
  //console.log("V1-Z: "+nodeLayer.getZIndex());
  //console.log("T-Z: "+Terrain.getZIndex());

  var dat = {{ overlay_data|safe }};

  //console.log({{ networks |safe}});
  //console.log(dat);
  /*
  for(network in dat)
  {
    for (device in network)

    var node = nodes[i];
    var point = new OpenLayers.Geometry.Point(node.lon,node.lat);	
    var pointFeature = new OpenLayers.Feature.Vector(point);
    Vector1.addFeatures([pointFeature]);
  }
  */
}


/* locate
 * Takes a string as input (hopefully an address)
 * and attemps to send that information to google
 * to recieve a json object in return that contains
 * location information. This function returns an array
 * of two elements [lat,lon] for latitude and longitude.
 */
function locate(addr)
{
  var trans_input;
  var loc_info;
  var lat,lon
  trans_input = addr.replace(/ /g,"+");
  loc_info = httpGet("http://maps.googleapis.com/maps/api/geocode/json?address=" + trans_input + "&sensor=true");
       
  eval("json_rep = "+loc_info);
  lat = json_rep.results[0].geometry.location.lat;
  lon = json_rep.results[0].geometry.location.lng;
  return [lon,lat];
}

/* httpGet
 * Helper function that sends out a GET request to a desired
 * URL. The responsetext from google is actually json despite
 * the xmlHttp stuff.
 */
function httpGet(theUrl)
{
    var xmlHttp = null;

    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl, false );
    xmlHttp.send( null );
    return xmlHttp.responseText;
}
</script>


<script>
function add_overlays()
{
  /*
   * DRAW ALL NETWORK OVERLAYS
   */

  main_JSON = {{ overlay_data |safe }};
  dev_JSON = {{ overlay_device |safe }};
 
  //main_JSON = JSON.stringify(main_JSON);
  //console.log("POLYGON JSON:");
  //console.log(main_JSON);

   
  $.each(main_JSON, function(index, value)
  {
    //console.log(value['name']);
    // Forward JSON to OpenLayers...

    addPolygon(value['data']);


  });

  //console.log("DEVICE JSON");
  //console.log(dev_JSON);
  $.each(dev_JSON, function(index, value)
  {
    $.each(value, function(index,value)
    {
      //console.log(value);
      addPoint(value['lat'],value['lon']);
    });
  });
}
  

$(document).ready(function()
{

  var node_insert = 0;
  var current_device = 0;
  
  var network_id; // Most insecure bullshit ever.... Will make more secure later....
  $(".rpanel").hide(); // Hide the right panel on startup
  $("#toggle-rpanel-off").hide(); // hide the div that is to minimize the rpanel
  $(".lpanel").hide(); // Hide the left panel on startup
  $("#toggle-lpanel-off").hide(); // Hide leftpanel toggle
   

  $("#toggle-bpanel-on").hide();

  /* Draw default explore nodes */
  draw_nodes();

  var wiz_phase = 0;
  
  $("#existing-network-overlay").prop('checked',true);

  /* Open the rpanel */
  $(".toggle-rpanel").click(function(){
    $(".rpanel").toggle();
    $(".toggle-rpanel").toggle();
  });

  /* Open the lpenel */
  $(".toggle-lpanel").click(function(){
    $(".lpanel").toggle();
    $(".toggle-lpanel").toggle();
  });


  /* "Go button clicked. Try to locate address string */ 
  $("#addr-text-btn").click(function(){
    var coords = locate($('#addr-text-input').val());
    center = new OpenLayers.LonLat(coords[0],coords[1]);
    center.transform(from, to);
    map.setCenter(center, 16);
  });

  /* If a user presses return in the address field then
   * run the same code that would run when the "Go" 
   * button is pushed.
   */

  $("#addr-text-input").bind('keypress', function(e){
    if(e.keyCode==13){
      var coords = locate($('#addr-text-input').val());
      center = new OpenLayers.LonLat(coords[0],coords[1]);
      center.transform(from, to);
      map.setCenter(center, 16);
    }
  });

  /* If IP Locate is clicked try to locate via IP */
  $("#addr-ip-btn").click(function(){
    controls.locator.deactivate();
    controls.locator.activate();
  });


  /* Node Layer Checkboxes */

  // Existing Networks:
  $("#existing-network-overlay").click(function()
  {
    if ($("#existing-network-overlay").is(":checked"))
    {
      draw_nodes();
    }
    else
    {
      //alert("Uncheck'd");
    }
  });


  /* Bottom Panel show/hide */

  $(".toggle-bpanel").click(function()
  {
    $(".bpanel").toggle();
  });

  $("#toggle-bpanel-off").click(function()
  {
    $("#toggle-bpanel-off").hide();
    $("#toggle-bpanel-on").show();
  });

  $("#toggle-bpanel-on").click(function()
  {
    $("#toggle-bpanel-off").show();
    $("#toggle-bpanel-on").hide();
  });

  /* New Network Popup */

  $("#new-network-button").click(function()
  {
    $("#new-network-popup").show();
    $(".bpanel").hide();
    $(".toggle-bpanel").hide();
    wiz_phase=1;
  });

  $("#new-node-button").click(function()
  {
    addNodeMode();
    $("#node-name").val("");
    node_insert = 1;
    //$("new-node-popup").show();
    //$(".bpanel").hide();
    //$(".toggle-bpanel").hide();
  });



  $("#cancel-wizard-button").click(function()
  {
    $("#new-network-popup").hide();
  });

  $("#next-wizard-button").click(function()
  {
    wiz_phase++;
    if (wiz_phase == 2)
    {
      addPolyMode();

      var data = 
      { 
      "name": $("#network-name-input").val(), 
      "type_val": "UNKNOWN", 
      "phase_type_val": "FUN" 
      };
      data=JSON.stringify(data);
      
      /* AJAX SEND AND RETURN. SHOULD BE WRAPPED */
      $.ajax(
      {
        type: 'POST',
	contentType: "application/json; charset=utf-8",
        url: '/ajax/add_network',
	data: data,
	success: 
	function(data)
	{
	  network_id = data; // Cringeworthy I know x_x....
	},
        dataType: "json"
      });

      $(".wizard-phase-one").hide();
      $(".wizard-phase-two").show();
      $(".bpanel").hide();
      $(".toggle-bpanel").hide();
      $("#new-network-popup").animate(
      {
	top:'100%'
	, height:'134px'
      });
      var data = 
      {
      "data": $("#polygon-json-output").val(),
      "network_id": network_id.toString()
      };
      
      //alert("about to make poly request");
      data = JSON.stringify(data);
      $.ajax(
      {
        type: 'POST',
	contentType: "application/json; charset=utf-8",
        url: '/ajax/add_polygon',
	data: data,
	success: 
	function(data)
	{
	  console.log("add_polygon: " + data);
          window.location.replace("/build");
	},
        dataType: "json"
      });

    }

    else if (wiz_phase == 3)
    {
      $(".wizard-phase-one").hide();
      $(".wizard-phase-two").hide();
      //$(".wizard-phase-three").show();
      viewMode();

      var data = 
      {
      "data": $("#polygon-json-output").val(),
      "network_id": network_id.toString()
      };
      
      //alert("about to make poly request");
      data = JSON.stringify(data);
      $.ajax(
      {
        type: 'POST',
	contentType: "application/json; charset=utf-8",
        url: '/ajax/add_polygon',
	data: data,
	success: 
	function(data)
	{
	  console.log("add_polygon: " + data);
          window.location.replace("/build");
	},
        dataType: "json"
      });



    }

  });


{% if mode==2 %}
  var curNet = [];

  var type_selected = "UNKNOWN";
  var current_polarization = "UNKNOWN";

  $("#redrop-node-button").attr("disabled","disabled");

  $("#redrop-node-button").click(function()
  {
    addNodeMode();
  });
  

  my_net_types = {{ net_types | safe }};
  my_phase_types = {{ net_phase_types | safe }};
  my_polarization_types = {{ polarization_types | safe }};

  cnt = {{ networks|safe }}
  for (n in cnt)
  {
    name=(cnt[n]['name']);
    id=(cnt[n]['id']);
    $("#network-select").append("<option id='"+n+"'>"+name+"</option>");
  }

  $("#network-type").on('click','option', function()
  {
    type_selected = $(this).val();
  });

  $("#network-phase-type").on('click','option', function()
  {
    phase_type_val = $(this).val();
  });

  $("#polarization-type").on('click','option', function()
  {
    current_polarization = $(this).val();
  });


  $("#commit-network").click(function()
  {  
    var req =
    {
      network_id: curNet['id'],
      name: $("#network-name").val(),
      type_val: type_selected,
      phase_type_val: phase_type_val//NOT COMPLETE
    };

    req=JSON.stringify(req);

    $.ajax(
    {
      type: 'POST',
      contentType: "application/json; charset=utf-8",
      url: '/ajax/commit_network',
      data: req,
      success: function(data)
      {
        alert("Network Updated"); // CHANGE THIS
      },
      dataType: "json"
    });
  });



  $("#network-select").on('click','option', function()
  {
    curNet = cnt[parseInt($(this).attr('id'))];

    console.log(curNet);
    $("#network-name").val(curNet['name']);

    $("#network-type").append("<option id='network-current-type'>"+curNet['type_val']+"</option>");
    $.each(my_net_types, function(data,value)
    {
      //console.log(value);
      if (value['name'] != $("#network-current-type").val())
        $("#network-type").append(
		"<option id='"+value['name']+"'>"+value['name']+"</option>");
    });


    $("#network-phase-type").append(
	    "<option id='cur-net-phase-type'>"
	    +curNet['phase_type_val']
	    +"</option>");

    cur_net_phase_type = $("#cur-net-phase-type").val();
    phase_type_val = cur_net_phase_type;

    $.each(my_phase_types, function(data,value)
    {
      //console.log(value);
      if (value['name'] != $("#cur-net-phase-type").val())
        $("#network-phase-type").append(
		"<option id='"+value['name']+"'>"+value['name']+"</option>");
    });




    var req =
    {
      network_id: curNet['id']
    };

    req = JSON.stringify(req);

    $("#node-select").empty();

    $.ajax(
    {
      type: 'POST',
      contentType: "application/json; charset=utf-8",
      url: '/ajax/get_devices_for_network',
      data: req,
      success: function(data)
      {
        $.each(data, function(index, value)
        {
          $("#node-select").append("<option id='"+value['id']+"'>"+value['name']+"</option>");
        });
      },
      dataType: "json"
    });
  });

  $("#commit-node").click(function()
  {
    newnode = "FALSE";
    if (node_insert)
      newnode = "TRUE";

    var req = 
    {
      "new": newnode, 
      lat: $("#node-lat").val(),
      lon: $("#node-lon").val(),
      name: $("#node-name").val(),
      type_val: type_selected, // Fix
      polarization_type_val: current_polarization,
      azimuth: $("#azimuth-input").val(),
      elevation: $("#elevation-input").val(),
      status_type_val: "ONLINE", //FIX
      network_id: curNet['id'],
      device_id: current_device
    };

    req = JSON.stringify(req);

    $.ajax(
    {
      type: 'POST',
      contentType: "application/json; charset=utf-8",
      url: '/ajax/add_device',
      data: req,
      success: function(data)
      {
        alert("COMMITTED");
      },
      dataType: "json"
    });

    node_insert = 0;
  });

  $("#node-select").on('click', 'option', function()
  {
    current_device = parseInt($(this).attr('id'));

    my_node_types = {{ node_types | safe }};
    
    $("#node-type").empty();
    $("#node-type").append(
	    "<option id='node-current-type'>Node Type</option>");

    $("#polarization-type").empty();
    $("#polarization-type").append(
		    "<option id='current-polarization-type'>Polarization Type</option>");

    




    $("#redrop-node-button").removeAttr("disabled");
    
    req = 
    {
      device_id: parseInt($(this).attr('id'))
    };

    req=JSON.stringify(req);
    
    $.ajax(
    {
      type: 'POST',
      contentType: "application/json; charset=utf-8",
      url: '/ajax/get_device_info',
      data: req,
      success: function(data)
      {
        $("#node-lat").val(data['lat']);
	$("#node-lon").val(data['lon']);
	$("#node-name").val(data['name']);
	$("#node-current-type").text(data['type_val']);
	$("#node-current-type").val(data['type_val']);
	$("#current-polarization-type").val(data['polarization_type_val']);
        current_polarization = data['polarization_type_val'];
	$("#current-polarization-type").text(data['polarization_type_val']);
	$("#azimuth-input").val(data['azimuth']);
	$("#elevation-input").val(data['elevation']);

        $.each(my_node_types, function(data,value)
        {
          if (value['name'] != $("#node-current-type").val())
          $("#node-type").append(
		"<option>"+value['name']+"</option>");
        });

        $.each(my_polarization_types, function(data,value)
        {
          //console.log(value);
          if (value['name'] != $("#current-polarization-type").val())
          $("#polarization-type").append(
		"<option>"+value['name']+"</option>");
        });


      },
      dataType: "json"
    });

  });

{% endif %}

});
</script>

{% endblock %}

{% block body %}
<div id="user-bar">
  {{ current_username }} | 
  {% if current_user.is_authenticated() %}
    <a href="{{ url_for('logout') }}">logout</a>
  {% else %}
    <a href="{{ url_for('login') }}">login</a> or 
    <a href="{{ url_for('register') }}">register</a>
  {% endif %}
</div>
<div id="map-wrapper">
  <div id="map-container" class="olMap"></div>
</div>

<div id="toggle-rpanel-on" class="toggle-rpanel"></div>
<div id="explore-rpanel" class="rpanel">
  <h2>Location</h2>
  <hr />
  Address:
  <input id="addr-text-input" name="addr" type="text" size=20></input>
  <input id="addr-text-btn" type="button" value="Go">
  <input id="addr-ip-btn" type="button" value="Locate by IP">
  <h2>Layers</h2>
  <hr />
  <h4>Map</h4>
  <div id="layerswitcher" class="olContro lLayerSwitcher"></div>
  
  <!--
  <dl>
  <dt><input type="radio" name="layers" id="street-layer">Street</input></dt>
  <dt><input type="radio" name="layers" id="terrain-layer">Terrain</input></dt>
  <dt><input type="radio" name="layers" id="image-layer">Image</input></dt>
  </dl>

  REMOVED. Went with embedding olControlLayerSwitcher inside the sidepanel
  and overriding all the styles in olstyle.css.
  -->


  <h4>Overlays</h4>
  <dl>
    <dt><input type="checkbox" id="existing-network-overlay" value="true">Existing Networks</input></dt>
    <dt><input type="checkbox" id="planned-networks-overlay">Planned Networks</input></dt>
    <dt><input type="checkbox" id="conceptual-networks-overlay">Conceptual Networks</input></dt>
  </dl>
</div>
<div id="toggle-rpanel-off" class="toggle-rpanel"></div>
<div id="toggle-lpanel-on" class="toggle-lpanel"></div>
<div id="explore-lpanel" class="lpanel">
  <h2 align=center>Info</h2>
  <hr />
</div>
<div id="toggle-lpanel-off" class="toggle-lpanel"></div>

{% if mode==2 %} 
  <!-- Render the bottom build panel -->
<div id="build-panel" class="bpanel">
  <div id="net-panel" class="bpanel-sect">
    <select id="network-select" class="main-select">
      <option value="none" selected="selected">Select Network</option>
    </select>
    <input type="button" 
      id="new-network-button" 
      class="bpanel-sect-title" 
      value="New" 
      style="display:inline">
    </input>
    <hr />
    Name: <input id="network-name" name="net-name" type="text" size="25"></input>
    Type: 
    <select id="network-type" class="main-select">
    </select><br />
    Phase:
    <select id="network-phase-type" class="main-select">
    </select>

    <!--
    <dl>
      <dt><input type="radio" name="net-type" id="type-fun">Just For Fun</input></dt>
      <dt><input type="radio" name="net-type" id="type-planned">Planned</input></dt>
      <dt><input type="radio" name="net-type" id="type-inproc">Under Construction</input></dt>
      <dt><input type="radio" name="net-type" id="type-online">Online!</input></dt>
    </dl>a
    -->
    <dl class="left-bottom-btn">
      <dt class="rlist"><input type="button" id="polygon-mode-btn" value="Polygon"></input></dt>
      <dt class="rlist"><input type="button" id="profile-mode-btn" value="Profile"></input></dt>
    </dl>
    <input type="button" id="commit-network" class="right-bottom-btn" value="COMMIT"></input>
  </div>
  
  <div id="node-panel" class="bpanel-sect">

    <select id="node-select" class="main-select">
      <option value="none" selected="selected">Select Node</option>
    </select>
    <input type="button" 
      id="new-node-button" 
      class="bpanel-sect-title" 
      value="New" 
      style="display:inline">
    </input>
    <input type="button"
      id="redrop-node-button"
      class="bpanel-sect-title"
      value="Redrop"
      style="display:inline">
    </input>
    <hr />
    Name: <input id="node-name" name="node-name" type="text" size="25"></input>
    
    lat:<input type="text" id="node-lat" size="13"></input> <br />
    lon:<input type="text" id="node-lon" size="13"></input> <br />
    type:<select id="node-type"></select><br />
    polarization:<select id="polarization-type"></select> <br />
    elevation:<input type="text" id="elevation-input" size="4"></input><br />
    azimuth:<input type="text" id="azimuth-input" size="4"></input><br />
      <!--
      <dt class="rlist">type:<input type="text" id="node-type" size="10" value="DROP DOWN"></input></dt>
      -->

    <!--
    <h2>About/Notes</h2>
    <textarea id="nodes-about" rows="2" cols="40"></textarea>
    -->
    <input type="button" id="commit-node" class="right-bottom-btn" value="COMMIT"></input>
  </div>
<!--
  <div id="info-panel" class="bpanel-sect">
    <h2>Info</h2>
    <hr />
    <div id="info-panel-disp">
      To be updated with relevant info as the user mouses over different elements of the build panel.
    </div>
    <input type="button" id="help-mode" class="right-bottom-btn" value="HELP"></input>
  </div>
-->
</div>
<div id="toggle-bpanel-off" class="toggle-bpanel"></div>
<div id="toggle-bpanel-on" class="toggle-bpanel"></div>


<!-- Net network -->
<div id="new-network-popup" class="popup">
  <div id="network-wizard-top" class="popup-top"></div>
  <h2 class="popup-title wizard-phase-one">New Network</h2>
  <h2 class="popup-title wizard-phase-two">Polygon</h2>
  <hr />

  <!-- Begin Dynamic Content -->

  <div class="wizard-phase-one">
    <p>
    First, you need to pick a name for your new network. Don't worry too much about this
    as it can be changed at a later time. 
    </p>
    
    <div class="wizard-input">
    <h3 class="rlist">Name</h3>
    <input id="network-name-input" class="rlist" type="text" size=20></input>
    </div>
  </div>
  <div class="wizard-phase-two">
    <!--
    <p>
    Now, we will construct a polygon to represent the intended coverage area/geometry
    of your dream network. This polygon can be updated later if you are too ambitious
    or wish to expand a network!.
    </p>
    <p>
    Clicking on the map will begin to draw the polygon. Hit clear to start over.
    </p>
    -->
    <input type="button" class="important-btn centered" value="Clear" onclick="clearAddPoly();"></input>
    <textarea id="polygon-json-output"></textarea>
  </div>
  <div id="wizard-phase-three">
    <!--
    <p>
    Now it's time to see what it would take to cover that area. Use the panel below
    to select nodes and drop them on to the map.
    </p
    -->
  </div>
  <dl class="popup-bottom-r">
    <dt class="rlist">
      <input type="button" 
        id="cancel-wizard-button" 
        value="Cancel" 
        style="display:inline">
      </input>
    </dt>
    
    <dt class="rlist">
      <input type="button" 
        id="back-wizard-button" 
        disabled="true"
	value="Back" 
        style="display:inline">
      </input>
    </dt>
    
    <dt class="rlist">
      <input type="button" 
        id="next-wizard-button" 
        class="important-btn"
	value="Next" 
        style="display:inline">
      </input>
    </dt>
  </dl>
</div>

{% endif %}
{% endblock %}
